<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Preview</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Referencia local a lz-string -->
    <script src="js/lz-string.min.js"></script>
    <!-- Referencia al manifest para PWA -->
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div id="options">
        <h2>Elige cómo ver el contenido:</h2>
        <button id="btnVer">Ver en el navegador</button>
        <button id="btnDescargar">Descargar aplicación</button>
    </div>
    
    <iframe id="contentFrame" style="display:none; width:100%; height:90vh;"></iframe>

    <script>
        // Capturar el evento beforeinstallprompt para la instalación de la PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log("Evento beforeinstallprompt capturado.");
        });

        // Obtener el código comprimido de la URL
        const params = new URLSearchParams(window.location.search);
        const compressedCode = params.get('code');
        let decompressedHTML = "";
        if (compressedCode) {
            try {
                decompressedHTML = LZString.decompressFromEncodedURIComponent(compressedCode);
            } catch (error) {
                document.body.innerHTML = `<p style="color:red">Error al cargar el código.</p>`;
            }
        } else {
            document.body.innerHTML = `<p>No se proporcionó código.</p>`;
        }

        // Opción: Ver en el navegador
        document.getElementById('btnVer').addEventListener('click', () => {
            document.getElementById('options').style.display = "none";
            const frame = document.getElementById('contentFrame');
            frame.style.display = "block";
            frame.srcdoc = decompressedHTML;
        });

        // Opción: Descargar (instalar la PWA)
        document.getElementById('btnDescargar').addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') {
                        console.log('El usuario instaló la PWA.');
                    } else {
                        console.log('El usuario canceló la instalación.');
                    }
                    deferredPrompt = null;
                });
            } else {
                alert("Para instalar la aplicación, usa la opción 'Agregar a pantalla de inicio' en tu navegador.");
            }
        });
    </script>
</body>
</html>
